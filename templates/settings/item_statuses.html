{% extends "base.html" %}
{% block content %}
<h2 class="page-title">物品状态设置（拖拽排序）</h2>

<div class="card">
  <div class="btn-row">
    <!-- 一级状态切换：在库 / 出库 -->
    <div id="group-tabs" class="btn-group">
      <button type="button" class="btn primary" data-group="在库">在库</button>
      <button type="button" class="btn" data-group="出库">出库</button>
    </div>

    <div class="spacer"></div>

    <button class="btn primary" id="btn-add">添加</button>
    <a class="btn" href="{{ url_for('settings_stockin') }}">返回入库设置</a>
  </div>
</div>

<div class="card">
  <div class="card-title">
    <span id="current-group-label">当前一级状态：在库</span>
    <span style="font-size:12px;color:#888;margin-left:8px;">（拖动行可调整当前一级状态内的顺序）</span>
  </div>
  <div class="table-wrap">
    <table class="table excel" id="tbl-statuses">
      <thead>
        <tr>
          <th style="width:60px">序号</th>
          <th>二级状态</th>
          <th style="width:160px">操作</th>
        </tr>
      </thead>
      <tbody id="sortable"></tbody>
    </table>
  </div>
</div>

<!-- 新增弹窗 -->
<div class="modal" id="dlg" style="display:none">
  <div class="modal-inner small">
    <div class="modal-header">新增状态</div>
    <div class="modal-body">
      <div style="margin-bottom:6px;font-size:13px;color:#666;">
        所属一级状态：<span id="add-group-name">在库</span>
      </div>
      <input id="inp-name" class="input" placeholder="例：待上拍"/>
      <div id="err-dup" class="error" style="display:none">已存在或无效</div>
    </div>
    <div class="modal-footer">
      <button class="btn" id="btn-cancel">取消</button>
      <button class="btn primary" id="btn-ok">确定</button>
    </div>
  </div>
</div>

<!-- 编辑弹窗 -->
<div class="modal" id="dlg-edit" style="display:none">
  <div class="modal-inner small">
    <div class="modal-header">编辑状态</div>
    <div class="modal-body">
      <div style="margin-bottom:6px;font-size:13px;color:#666;">
        所属一级状态：<span id="edit-group-name">在库</span>
        <span style="margin-left:6px;color:#999;">（如需更换一级状态，请删除后在目标分组重新添加）</span>
      </div>
      <input id="inp-edit-name" class="input" placeholder="例：待上拍"/>
      <div id="err-edit" class="error" style="display:none">已存在或无效</div>
    </div>
    <div class="modal-footer">
      <button class="btn" id="btn-edit-cancel">取消</button>
      <button class="btn primary" id="btn-edit-ok">保存</button>
    </div>
  </div>
</div>

<!-- 轻提示 -->
<div id="toast" class="toast" aria-live="polite"></div>

<script>
(function(){
  const TBY = document.getElementById('sortable');
  const btnAdd = document.getElementById('btn-add');

  const groupTabs = document.querySelectorAll('#group-tabs button[data-group]');
  const currentGroupLabel = document.getElementById('current-group-label');
  const addGroupName = document.getElementById('add-group-name');
  const editGroupName = document.getElementById('edit-group-name');

  // 当前一级状态（父级）：在库 / 出库
  let currentGroup = '在库';

  // 新增弹窗
  const dlg = document.getElementById('dlg');
  const btnCancel = document.getElementById('btn-cancel');
  const btnOK = document.getElementById('btn-ok');
  const inp = document.getElementById('inp-name');
  const errDup = document.getElementById('err-dup');

  // 编辑弹窗
  const dlgEdit = document.getElementById('dlg-edit');
  const inpEdit = document.getElementById('inp-edit-name');
  const errEdit = document.getElementById('err-edit');
  const btnEditCancel = document.getElementById('btn-edit-cancel');
  const btnEditOK = document.getElementById('btn-edit-ok');
  let editingTr = null;
  let originalName = "";

  // 轻提示
  const toast = document.getElementById('toast');
  let toastTimer = null;
  function showToast(msg){
    toast.textContent = msg || '';
    toast.classList.add('show');
    clearTimeout(toastTimer);
    toastTimer = setTimeout(()=> toast.classList.remove('show'), 1600);
  }

  // 切换一级状态按钮样式 & 文本
  function refreshGroupUI(){
    groupTabs.forEach(btn=>{
      const g = btn.dataset.group || '';
      if (g === currentGroup){
        btn.classList.add('primary');
      } else {
        btn.classList.remove('primary');
      }
    });
    if (currentGroupLabel){
      currentGroupLabel.textContent = '当前一级状态：' + (currentGroup || '未分组');
    }
    if (addGroupName){
      addGroupName.textContent = currentGroup || '未分组';
    }
    if (editGroupName){
      editGroupName.textContent = currentGroup || '未分组';
    }
  }

  groupTabs.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const g = btn.dataset.group || '';
      if (g === currentGroup) return;
      currentGroup = g;
      refreshGroupUI();
      load();
    });
  });

  let lastOrder = [];
  function getCurrentOrder(){
    return [...TBY.querySelectorAll('tr')].map(tr => tr.dataset.name);
  }

  async function autoSaveOrderIfChanged(){
    const now = getCurrentOrder();
    if (JSON.stringify(now) === JSON.stringify(lastOrder)) return;
    const r = await fetch("/api/settings/item_statuses/reorder", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({
        names: now,
        group: currentGroup || ""
      })
    });
    const d = await r.json();
    if(d.ok){
      lastOrder = now;
      showToast("已自动保存顺序");
    }else{
      alert(d.error || "保存排序失败");
    }
  }

  function rowTpl(i, name){
    return `
      <tr draggable="true" data-name="${name}">
        <td class="idx">${i}</td>
        <td class="name">${name}</td>
        <td>
          <button class="btn mini btn-edit">编辑</button>
          <button class="btn mini danger btn-del">删除</button>
        </td>
      </tr>`;
  }

  async function load(){
    TBY.innerHTML = "";
    const params = currentGroup ? ("?group=" + encodeURIComponent(currentGroup)) : "";
    const res = await fetch("/api/settings/item_statuses/list" + params);
    const data = await res.json();
    (data.items||[]).sort((a,b)=>a.sort-b.sort).forEach((it, i)=>{
      TBY.insertAdjacentHTML('beforeend', rowTpl(i+1, it.name));
    });
    bindRowEvents();
    lastOrder = getCurrentOrder();
  }

  function bindRowEvents(){
    TBY.querySelectorAll("tr").forEach(tr=>{
      tr.addEventListener('dragstart', e=>{
        tr.classList.add('dragging'); e.dataTransfer.effectAllowed = 'move';
      });
      tr.addEventListener('dragend', async ()=>{
        tr.classList.remove('dragging');
        await autoSaveOrderIfChanged();
      });
    });
  }

  // 拖拽排序
  TBY.addEventListener('dragover', e=>{
    e.preventDefault();
    const dragging = TBY.querySelector('.dragging');
    if(!dragging) return;
    const after = getDragAfter(TBY, e.clientY);
    if(after == null) TBY.appendChild(dragging);
    else TBY.insertBefore(dragging, after);
    refreshIndex();
  });
  function getDragAfter(container, y){
    const els = [...container.querySelectorAll('tr:not(.dragging)')];
    return els.reduce((closest, child)=>{
      const box = child.getBoundingClientRect();
      const offset = y - box.top - box.height/2;
      if(offset < 0 && offset > closest.offset) return {offset, element: child};
      else return closest;
    }, {offset: Number.NEGATIVE_INFINITY}).element;
  }
  function refreshIndex(){ TBY.querySelectorAll('.idx').forEach((td, i)=> td.textContent = i+1); }

  // 删除
  TBY.addEventListener('click', async (e)=>{
    const btn = e.target.closest('.btn-del');
    if(!btn) return;
    const tr = btn.closest('tr');
    const name = tr.dataset.name;
    if(!confirm("确定删除 "+ name +" ?")) return;
    const r = await fetch("/api/settings/item_statuses_delete", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({name})
    });
    const d = await r.json();
    if(d.ok){ tr.remove(); refreshIndex(); showToast("已删除"); }
    else alert(d.error || "删除失败");
  });

  // 新增
  function openAdd(){
    dlg.style.display='flex';
    inp.value = "";
    errDup.style.display='none';
    addGroupName.textContent = currentGroup || '未分组';
    setTimeout(()=> inp.focus(), 0);
  }
  function closeAdd(){ dlg.style.display='none'; }

  btnAdd.addEventListener('click', openAdd);
  btnCancel.addEventListener('click', closeAdd);
  btnOK.addEventListener('click', async ()=>{
    const name = (inp.value||"").trim();
    if(!name){
      errDup.textContent="值不能为空";
      errDup.style.display='block';
      return;
    }
    const r = await fetch("/api/settings/item_statuses_add", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({
        name,
        group: currentGroup || ""
      })
    });
    const d = await r.json();
    if(d.ok){
      closeAdd();
      showToast("已添加");
      await load();
    }
    else if(d.error==='duplicate'){
      errDup.textContent="已存在";
      errDup.style.display='block';
    }
    else{
      errDup.textContent=d.error||"添加失败";
      errDup.style.display='block';
    }
  });

  // 编辑
  function openEdit(name, tr){
    editingTr = tr;
    originalName = name || "";
    inpEdit.value = originalName;
    errEdit.style.display = 'none';
    editGroupName.textContent = currentGroup || '未分组';
    dlgEdit.style.display = 'flex';
    setTimeout(()=> inpEdit.focus(), 0);
  }
  function closeEdit(){
    dlgEdit.style.display = 'none';
    editingTr = null;
    originalName = "";
  }

  TBY.addEventListener('click', (e)=>{
    const btn = e.target.closest('.btn-edit');
    if(!btn) return;
    const tr = btn.closest('tr');
    openEdit(tr.dataset.name, tr);
  });
  btnEditCancel.addEventListener('click', closeEdit);
  btnEditOK.addEventListener('click', async ()=>{
    if(!editingTr) return;
    const newName = (inpEdit.value||"").trim();
    if(!newName){
      errEdit.textContent = "值不能为空";
      errEdit.style.display = 'block';
      return;
    }
    if(newName === originalName){
      showToast("未修改");
      return;
    }
    const r = await fetch("/api/settings/item_statuses", {
      method:"PUT",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({old: originalName, new: newName})
    });
    const d = await r.json();
    if(d.ok){
      editingTr.dataset.name = newName;
      const td = editingTr.querySelector('.name');
      if(td) td.textContent = newName;
      closeEdit();
      lastOrder = getCurrentOrder();
      showToast("已保存");
    }else{
      errEdit.textContent = d.error || "保存失败";
      errEdit.style.display = 'block';
    }
  });

  // 弹窗增强：遮罩/ESC/Enter
  dlg.addEventListener('click', (e)=>{ if(e.target === dlg) closeAdd(); });
  dlgEdit.addEventListener('click', (e)=>{ if(e.target === dlgEdit) closeEdit(); });
  document.addEventListener('keydown', (e)=>{
    if(dlg.style.display === 'flex' && e.key === 'Escape') closeAdd();
    if(dlgEdit.style.display === 'flex' && e.key === 'Escape') closeEdit();
  });
  inp.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); btnOK.click(); }});
  inpEdit.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); btnEditOK.click(); }});

  // 初始加载
  refreshGroupUI();
  load();
})();
</script>
{% endblock %}
