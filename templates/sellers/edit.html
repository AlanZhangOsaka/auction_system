{% extends "base.html" %}
{% block content %}
<h2 class="page-title">出品人详情与修改</h2>

<div class="card">
  <div class="form-vertical">
    <div class="row">
      <label>出品人序号（只读）
        <input id="f_code" class="input" readonly value="{{ seller_code }}">
      </label>
    </div>

    <div class="row">
      <label>出品人姓名
        <input id="f_name" class="input" placeholder="必填">
      </label>
    </div>

    <div class="row">
      <label>卖方佣金
        <div class="input-percent">
          <input id="f_percent" type="number" class="input" min="0" max="100" step="0.01" placeholder="0~100，支持小数">
          <span>%</span>
        </div>
      </label>
    </div>

    <div class="row">
      <label>违约金比例
        <div class="input-percent">
          <input id="f_penalty" type="number" class="input" min="0" max="100" step="0.01" placeholder="0~100，支持小数">
          <span>%</span>
        </div>
      </label>
    </div>

    <div class="row inline">
      <label class="inline"><input id="f_cf" type="checkbox"> 图录费</label>
      <label class="inline"><input id="f_tax" type="checkbox"> 可抵税</label>
    </div>

    <div class="row">
      <label>登録番号
        <input id="f_taxcode" class="input">
      </label>
    </div>

    <div class="row">
      <label>付款账户
        <input id="f_account" class="input">
      </label>
    </div>

    <div class="row">
      <label>联系方式
        <input id="f_phone" class="input">
      </label>
    </div>

    <div class="row">
      <label>地址
        <textarea id="f_addr" class="textarea" rows="2"></textarea>
      </label>
    </div>

    <div class="row">
      <label>备注
        <textarea id="f_notes" class="textarea" rows="2"></textarea>
      </label>
    </div>

    <div class="btn-row">
      <button class="btn primary" onclick="save()">保存修改</button>
      <a class="btn" href="{{ url_for('sellers_index') }}">返回列表</a>
    </div>
  </div>
</div>

<script>
const CODE = "{{ seller_code }}";

function fmtInPercent(v){
  if(v===null || v===undefined || v==='') return '';
  const num = Number(v);
  if (isNaN(num)) return '';
  // 0~1 小数转 0~100 的字符串（最多两位小数，去尾零）
  return (num*100).toFixed(2).replace(/\.?0+$/,'');
}

function readPercent(el){
  const v = el.value.trim();
  if(v==='') return null;
  if(!/^\d+(\.\d+)?$/.test(v)) return NaN;
  const n = parseFloat(v);
  if(n<0 || n>100) return NaN;
  return n;
}

async function load(){
  const res = await fetch(`/api/sellers/${encodeURIComponent(CODE)}`);
  const d = await res.json();
  if(!res.ok){ alert(d.error || res.status); return; }

  f_name.value = d.seller_name || '';
  f_percent.value = fmtInPercent(d.seller_percent);
  f_penalty.value = fmtInPercent(d.seller_penalty_ratio);
  f_cf.checked = !!d.is_catalog_fee_required;
  f_tax.checked = !!d.is_tax_deductible;
  f_taxcode.value = d.seller_tax_code || '';
  f_account.value = d.seller_payment_account || '';
  f_phone.value = d.seller_phone || '';
  f_addr.value = d.seller_address || '';
  f_notes.value = d.seller_notes || '';
}

async function save(){
  const name = f_name.value.trim();
  if(!name){ alert('出品人姓名为必填'); return; }
  const sp = readPercent(f_percent);
  const pr = readPercent(f_penalty);
  if(Number.isNaN(sp)){ alert('卖方佣金必须是 0~100 之间的数字，可带小数'); return; }
  if(Number.isNaN(pr)){ alert('违约金比例必须是 0~100 之间的数字，可带小数'); return; }

  const payload = {
    seller_name: name,
    seller_percent: sp===null ? null : sp/100,
    seller_penalty_ratio: pr===null ? null : pr/100,
    is_catalog_fee_required: f_cf.checked,
    is_tax_deductible: f_tax.checked,
    seller_tax_code: f_taxcode.value || null,
    seller_payment_account: f_account.value || null,
    seller_phone: f_phone.value || null,
    seller_address: f_addr.value || null,
    seller_notes: f_notes.value || null
  };

  const res = await fetch(`/api/sellers/${encodeURIComponent(CODE)}`, {
    method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
  });
  const d = await res.json();
  if(!res.ok){ alert('保存失败：'+(d.error||res.status)); return; }
  alert('保存成功');
  location.href = "{{ url_for('sellers_index') }}";
}

load();
</script>
{% endblock %}
